123云盘集成需求文档

  📋 项目信息

| 项目名称 | Telegram Media Downloader - 123云盘集成 |
| -------- | --------------------------------------- |
| 版本     | v2.2.1                                  |
| 需求类型 | 功能增强                                |
| 优先级   | 中                                      |
| 预估工期 | 3-5天                                   |
| 负责人   | 开发团队                                |

---
  🎯 需求概述

  背景

  现有项目已支持rclone（100+云盘）和阿里云盘(aligo)作为云存储选项，用户需要更多云盘选择。123云
  盘作为知名国内云存储服务，具有良好的API支持和用户基础，集成后可为用户提供更多存储选择。

  目标

  在现有云盘架构基础上，集成123云盘作为第三个云存储选项，保持与rclone/aligo一致的用户体验和功能
  完整性。

  价值

  - 扩展存储选择：为用户提供更多云盘选项
  - 降低依赖风险：分散单一云盘服务的依赖
  - 提升用户体验：国内云盘访问速度更优

---
  🔍 现状分析

  现有架构

  graph TB
      A[Telegram Media Downloader] --> B[CloudDrive模块]
      B --> C[Rclone适配器]
      B --> D[Aligo适配器]
      B --> E[配置管理]
      E --> F[路径配置]
      E --> G[文件名配置]
      E --> H[上传控制]

  已有功能

| 功能模块 | Rclone | Aligo | 说明                   |
| -------- | ------ | ----- | ---------------------- |
| 文件上传 | ✅      | ✅     | 支持各种文件类型       |
| 目录创建 | ✅      | ✅     | 自动创建目录结构       |
| 路径映射 | ✅      | ✅     | 本地路径到云盘路径映射 |
| 文件压缩 | ✅      | ✅     | 上传前可选压缩         |
| 本地删除 | ✅      | ✅     | 上传后可选删除本地文件 |
| 进度监控 | ✅      | ❌     | Rclone支持进度显示     |
| 错误重试 | ✅      | ✅     | 网络异常自动重试       |

  配置机制

  # 现有配置结构
  save_path: D:\telegram_media_downloader
  file_path_prefix: [chat_title, media_datetime, media_type]
  file_name_prefix: [message_id, file_name]
  upload_drive:
    enable_upload_file: true
    upload_adapter: rclone|aligo  # 现有选项
    remote_dir: "drive:/telegram"
    after_upload_file_delete: true

---
  📝 需求详情

  功能需求

  FR-001：123云盘适配器实现

  描述：实现完整的123云盘API适配器
  优先级：高
  实现方案：
  # /module/pan123_client.py
  class Pan123Client:
      """123云盘API客户端"""
      async def authenticate() -> str
      async def create_folder(parent_id: int, name: str) -> int
      async def upload_file_single(file_path: str, parent_id: int) -> bool
      async def upload_file_multipart(file_path: str, parent_id: int) -> bool
      async def get_upload_progress(preupload_id: str) -> dict

  验收标准：
  - ✅ 支持OAuth2.0认证，自动获取access_token
  - ✅ 支持单步上传（<1GB文件）
  - ✅ 支持分片上传（≥1GB文件）
  - ✅ 支持秒传检测（MD5匹配）
  - ✅ 支持上传进度监控
  - ✅ 支持文件夹创建和管理

  FR-002：路径映射系统

  描述：解决123云盘基于目录ID的路径管理问题
  优先级：高
  实现方案：
  # /module/pan123_client.py  
  class Pan123PathManager:
      def __init__(self, client: Pan123Client):
          self.path_cache = {}  # "/telegram/频道/2023_12" -> folder_id

      async def ensure_path_exists(self, remote_path: str) -> int:
          """递归创建路径，返回最终目录ID"""
          # 路径解析: /telegram/频道名/2023_12/photo
          # 递归创建: 根目录(0) -> telegram -> 频道名 -> 2023_12 -> photo
          # 缓存结果: 避免重复API调用

  验收标准：
  - ✅ 支持递归目录创建
  - ✅ 路径到ID映射缓存机制
  - ✅ 与现有file_path_prefix配置完全兼容
  - ✅ 自动处理路径分隔符转换

  FR-003：配置集成

  描述：将123云盘集成到现有配置系统
  优先级：高实现方案：
  # config.yaml扩展
  upload_drive:
    upload_adapter: pan123           # 🆕 新增选项
    client_id: "your_client_id"      # 🆕 123云盘专用
    client_secret: "your_secret"     # 🆕 123云盘专用  
    remote_dir: "/telegram"          # 云盘根目录
    # 其他配置与现有保持一致

  验收标准：
  - ✅ 配置解析兼容现有格式
  - ✅ 新增123云盘专用配置项
  - ✅ 配置验证和错误提示
  - ✅ 向前兼容，不影响现有用户

  FR-004：CloudDrive模块集成

  描述：将123云盘适配器集成到CloudDrive统一接口
  优先级：高
  实现方案：
  # /module/cloud_drive.py修改
  class CloudDrive:
      @staticmethod  
      async def pan123_upload_file(drive_config, save_path, local_file_path) -> bool:
          # 1. 处理文件压缩逻辑
          # 2. 计算远程路径（复用现有逻辑）
          # 3. 确保远程目录存在
          # 4. 选择合适上传方式（单步/分片）
          # 5. 执行上传操作
          # 6. 处理上传后删除逻辑

      @staticmethod
      async def upload_file(drive_config, save_path, local_file_path) -> bool:
          # 在现有rclone/aligo基础上新增pan123分支
          if drive_config.upload_adapter == "pan123":
              return await CloudDrive.pan123_upload_file(...)

  验收标准：
  - ✅ 与rclone/aligo使用相同的调用接口
  - ✅ 支持所有现有功能（压缩、删除、进度等）
  - ✅ 异常处理与现有模块一致
  - ✅ 日志记录格式统一

  非功能需求

  NFR-001：性能要求

  - 上传速度：充分利用123云盘API性能
  - 并发控制：遵守API频率限制（文件上传2次/秒）
  - 内存占用：大文件分片上传，控制内存使用
  - 网络优化：支持断点续传，网络异常自动重试

  NFR-002：可靠性要求

  - 数据安全：仅上传成功后删除本地文件
  - 异常恢复：上传失败保留本地文件
  - 令牌管理：access_token自动刷新
  - 错误处理：完善的异常捕获和日志记录

  NFR-003：兼容性要求

  - 向前兼容：不影响现有rclone/aligo用户
  - 配置兼容：现有配置格式保持不变
  - 平台兼容：支持Windows/Linux/macOS
  - Python版本：支持Python 3.7+

  NFR-004：可维护性要求

  - 代码结构：遵循现有架构模式
  - 单元测试：核心功能测试覆盖率>80%
  - 文档完整：API文档和使用说明
  - 日志规范：统一的日志格式和级别

---
  🛠️ 实现方案

  技术架构

  graph TB
      subgraph "现有架构"
          A[Application] --> B[CloudDrive]
          B --> C[RcloneAdapter]
          B --> D[AligoAdapter]
      end

      subgraph "新增模块"
          E[Pan123Client] --> F[认证管理]
          E --> G[文件上传]
          E --> H[目录管理]
          I[Pan123PathManager] --> J[路径缓存]
          I --> K[ID映射]
      end
    
      subgraph "集成接口"
          B --> L[Pan123Adapter]
          L --> E
          L --> I
      end

  模块设计

  1. Pan123Client（核心客户端）

  文件：/module/pan123_client.py
  职责：封装123云盘API调用
  关键方法：
  class Pan123Client:
      def __init__(self, client_id: str, client_secret: str):
          self.base_url = "https://open-api.123pan.com"
          self.session = httpx.AsyncClient()
          self.access_token = None

      async def authenticate(self) -> str:
          """获取访问令牌"""
          payload = {
              "clientID": self.client_id,
              "clientSecret": self.client_secret
          }
          headers = {"Platform": "open_platform"}
          # POST /api/v1/access_token
    
      async def get_upload_domains(self) -> List[str]:
          """获取上传域名列表"""
          # GET /upload/v2/file/domain
    
      async def create_file(self, parent_id: int, filename: str, 
                           etag: str, size: int) -> dict:
          """创建文件（检测秒传）"""
          # POST /upload/v2/file/create
    
      async def upload_single(self, file_path: str, parent_id: int, 
                             **kwargs) -> bool:
          """单步上传"""
          # POST {domain}/upload/v2/file/single/create
    
      async def upload_slice(self, preupload_id: str, slice_no: int,
                            slice_data: bytes, slice_md5: str) -> bool:
          """分片上传"""
          # POST {domain}/upload/v2/file/slice
    
      async def upload_complete(self, preupload_id: str) -> dict:
          """完成上传"""
          # POST /upload/v2/file/upload_complete
    
      async def create_folder(self, parent_id: int, name: str) -> int:
          """创建文件夹"""
          # POST /upload/v1/file/mkdir

  2. Pan123PathManager（路径管理器）

  文件：/module/pan123_client.py
  职责：处理路径到目录ID的映射
  关键方法：
  class Pan123PathManager:
      def __init__(self, client: Pan123Client):
          self.client = client
          self.path_cache = {}  # 路径缓存

      async def ensure_path_exists(self, remote_path: str) -> int:
          """确保路径存在，返回最终目录ID"""
          # 示例: "/telegram/TechChannel/2023_12/photo"
          # 解析为: ["telegram", "TechChannel", "2023_12", "photo"]
          # 递归创建并缓存每层目录ID
    
      def _normalize_path(self, path: str) -> str:
          """标准化路径格式"""
          return path.strip('/').replace('\\', '/')
    
      def clear_cache(self):
          """清空路径缓存"""
          self.path_cache.clear()

  3. CloudDrive集成（适配器层）

  文件：/module/cloud_drive.py
  职责：将123云盘集成到统一云盘接口
  修改内容：
  class CloudDriveConfig:
      def __init__(self):
          # 现有字段...
          self.pan123_client_id = ""       # 🆕
          self.pan123_client_secret = ""   # 🆕  
          self.pan123_client = None        # 🆕
          self.pan123_path_manager = None  # 🆕

  class CloudDrive:
      @staticmethod
      async def pan123_upload_file(drive_config: CloudDriveConfig,
                                  save_path: str, 
                                  local_file_path: str,
                                  progress_callback: Callable = None,
                                  progress_args: tuple = ()) -> bool:
          """123云盘上传实现"""
          # 实现细节见下文

      @staticmethod  
      async def upload_file(drive_config: CloudDriveConfig,
                           save_path: str,
                           local_file_path: str) -> bool:
          """统一上传接口"""
          if drive_config.upload_adapter == "rclone":
              return await CloudDrive.rclone_upload_file(...)
          elif drive_config.upload_adapter == "aligo":
              return CloudDrive.aligo_upload_file(...)
          elif drive_config.upload_adapter == "pan123":  # 🆕
              return await CloudDrive.pan123_upload_file(...)

  4. 配置管理集成

  文件：/module/app.py
  职责：解析123云盘配置并初始化客户端
  修改内容：
  class Application:
      def assign_config(self, _config: dict) -> bool:
          """配置解析"""
          if _config.get("upload_drive"):
              upload_drive_config = _config["upload_drive"]

              # 🆕 123云盘配置解析
              if upload_drive_config.get("client_id"):
                  self.cloud_drive_config.pan123_client_id = upload_drive_config["client_id"]
              if upload_drive_config.get("client_secret"):
                  self.cloud_drive_config.pan123_client_secret =
  upload_drive_config["client_secret"]

      def pre_run(self):
          """运行前初始化"""
          # 🆕 123云盘客户端初始化
          if (self.cloud_drive_config.enable_upload_file and
              self.cloud_drive_config.upload_adapter == "pan123"):
    
              self.cloud_drive_config.pan123_client = Pan123Client(
                  self.cloud_drive_config.pan123_client_id,
                  self.cloud_drive_config.pan123_client_secret
              )
              self.cloud_drive_config.pan123_path_manager = Pan123PathManager(
                  self.cloud_drive_config.pan123_client
              )

  核心算法实现

  1. 智能上传策略

  async def pan123_upload_file(drive_config, save_path, local_file_path, 
                              progress_callback=None, progress_args=()) -> bool:
      """123云盘上传核心实现"""
      upload_status = False
      zip_file_path = ""

      try:
          # 1. 处理文件压缩
          file_path = local_file_path
          if drive_config.before_upload_file_zip:
              zip_file_path = CloudDrive.zip_file(local_file_path)
              file_path = zip_file_path
    
          # 2. 计算远程路径（复用现有逻辑）
          relative_dir = os.path.dirname(local_file_path).replace(save_path, "")
          remote_path = (drive_config.remote_dir + "/" +
                        relative_dir.replace("\\", "/")).replace("//", "/")
    
          # 3. 确保远程目录存在
          parent_id = await drive_config.pan123_path_manager.ensure_path_exists(remote_path)
    
          # 4. 获取文件信息
          file_size = os.path.getsize(file_path)
          file_name = os.path.basename(file_path)
          file_md5 = await calculate_md5(file_path)
    
          # 5. 创建文件（检测秒传）
          create_result = await drive_config.pan123_client.create_file(
              parent_id=parent_id,
              filename=file_name,
              etag=file_md5,
              size=file_size
          )
    
          # 6. 处理秒传
          if create_result.get("reuse"):
              logger.info(f"123pan instant upload: {file_name}")
              upload_status = True
          else:
              # 7. 选择上传策略
              if file_size < 1024 * 1024 * 1024:  # <1GB 单步上传
                  upload_status = await _upload_single_file(
                      drive_config, file_path, parent_id, progress_callback, progress_args
                  )
              else:  # ≥1GB 分片上传
                  upload_status = await _upload_multipart_file(
                      drive_config, file_path, create_result, progress_callback, progress_args
                  )
    
          # 8. 上传后处理（与现有逻辑一致）
          if upload_status:
              drive_config.total_upload_success_file_count += 1
              if drive_config.after_upload_file_delete:
                  os.remove(local_file_path)
              if zip_file_path and drive_config.before_upload_file_zip:
                  os.remove(zip_file_path)
              logger.info(f"123pan upload success: {local_file_path}")
    
      except Exception as e:
          logger.error(f"123pan upload error: {e}")
          upload_status = False
    
      return upload_status

  2. 分片上传实现

  async def _upload_multipart_file(drive_config, file_path, create_result, 
                                  progress_callback=None, progress_args=()) -> bool:
      """分片上传实现"""
      preupload_id = create_result["preuploadID"]
      slice_size = create_result["sliceSize"]
      upload_domains = create_result["servers"]

      total_size = os.path.getsize(file_path)
      uploaded_size = 0
      slice_no = 1
    
      try:
          with open(file_path, 'rb') as f:
              while True:
                  # 读取分片数据
                  slice_data = f.read(slice_size)
                  if not slice_data:
                      break
    
                  # 计算分片MD5
                  slice_md5 = hashlib.md5(slice_data).hexdigest()
    
                  # 上传分片
                  success = await drive_config.pan123_client.upload_slice(
                      preupload_id=preupload_id,
                      slice_no=slice_no,
                      slice_data=slice_data,
                      slice_md5=slice_md5,
                      upload_domains=upload_domains
                  )
    
                  if not success:
                      return False
    
                  # 更新进度
                  uploaded_size += len(slice_data)
                  if progress_callback:
                      progress = (uploaded_size / total_size) * 100
                      await progress_callback(uploaded_size, total_size, progress,
  *progress_args)

                  slice_no += 1
    
          # 完成上传
          complete_result = await drive_config.pan123_client.upload_complete(preupload_id)
          return complete_result.get("completed", False)
    
      except Exception as e:
          logger.error(f"123pan multipart upload error: {e}")
          return False

---
  📋 实现计划

  开发阶段

  阶段1：基础框架（1天）

  任务：
  - 创建Pan123Client基础框架
  - 实现OAuth2.0认证机制
  - 添加基础HTTP请求封装
  - 实现令牌自动刷新逻辑

  交付物：
  - module/pan123_client.py 基础版本
  - 认证功能单元测试

  阶段2：核心功能（2天）

  任务：
  - 实现单步上传功能
  - 实现分片上传功能
  - 实现目录创建和管理
  - 实现路径映射系统
  - 添加秒传检测机制

  交付物：
  - 完整的Pan123Client实现
  - Pan123PathManager实现
  - 核心功能单元测试

  阶段3：系统集成（1天）

  任务：
  - 集成到CloudDrive模块
  - 修改配置解析逻辑
  - 添加123云盘适配器
  - 实现统一接口调用

  交付物：
  - 修改后的cloud_drive.py
  - 修改后的app.py
  - 集成测试用例

  阶段4：测试优化（1天）

  任务：
  - 完整功能测试
  - 异常场景测试
  - 性能优化调整
  - 文档编写更新

  交付物：
  - 测试报告
  - 性能评估报告
  - 用户文档更新

  测试策略

  单元测试

  # tests/test_pan123_client.py
  class TestPan123Client:
      async def test_authenticate(self):
          """测试认证功能"""

      async def test_create_folder(self):
          """测试创建文件夹"""
    
      async def test_upload_single_file(self):
          """测试单步上传"""
    
      async def test_upload_multipart_file(self):
          """测试分片上传"""
    
      async def test_path_mapping(self):
          """测试路径映射"""

  集成测试

  # tests/test_pan123_integration.py  
  class TestPan123Integration:
      async def test_upload_with_compression(self):
          """测试压缩上传"""

      async def test_upload_with_deletion(self):
          """测试上传后删除"""
    
      async def test_directory_structure(self):
          """测试目录结构创建"""
    
      async def test_config_compatibility(self):
          """测试配置兼容性"""

  性能测试

  - 小文件上传：<10MB文件上传速度测试
  - 大文件上传：>1GB文件分片上传测试
  - 并发上传：多文件并发上传测试
  - 网络异常：断网恢复场景测试

---
  🎯 验收标准

  功能验收

  AC-001：基础功能

  - ✅ 支持123云盘账号认证登录
  - ✅ 支持单文件上传（各种文件类型）
  - ✅ 支持文件夹自动创建
  - ✅ 支持现有路径配置（file_path_prefix）
  - ✅ 支持现有文件名配置（file_name_prefix）

  AC-002：高级功能

  - ✅ 支持大文件分片上传
  - ✅ 支持文件秒传（MD5检测）
  - ✅ 支持上传进度监控
  - ✅ 支持上传前文件压缩
  - ✅ 支持上传后本地文件删除

  AC-003：配置功能

  - ✅ 配置文件格式与现有保持一致
  - ✅ 支持upload_adapter切换
  - ✅ 新增client_id/client_secret配置项
  - ✅ 配置错误时有明确提示信息

  AC-004：兼容性

  - ✅ 不影响现有rclone用户使用
  - ✅ 不影响现有aligo用户使用
  - ✅ 现有配置文件无需修改
  - ✅ 支持Windows/Linux/macOS平台

  性能验收

  PC-001：上传性能

  - ✅ 小文件上传速度≥5MB/s（网络条件良好）
  - ✅ 大文件分片上传支持断点续传
  - ✅ 并发上传不超过API频率限制
  - ✅ 内存占用<200MB（处理1GB文件时）

  PC-002：稳定性

  - ✅ 上传成功率≥95%（正常网络环境）
  - ✅ 网络异常时自动重试≤3次
  - ✅ 上传失败时不删除本地文件
  - ✅ 令牌过期时自动刷新

  质量验收

  QC-001：代码质量

  - ✅ 代码符合PEP 8规范
  - ✅ 核心功能单元测试覆盖率≥80%
  - ✅ 无安全漏洞（敏感信息不记录日志）
  - ✅ 异常处理覆盖所有API调用

  QC-002：文档质量

  - ✅ README.md包含123云盘配置说明
  - ✅ 配置示例完整正确
  - ✅ API文档完整（如需要）
  - ✅ 错误排查指南

---
  📊 影响评估

  用户影响

  正面影响

  - ✅ 新增选择：用户多一个云盘存储选项
  - ✅ 体验一致：使用方式与现有云盘完全相同
  - ✅ 功能完整：支持所有现有云盘功能
  - ✅ 性能提升：国内云盘访问速度更优

  负面影响

  - ❌ 学习成本：需要了解123云盘API申请流程
  - ❌ 依赖增加：新增httpx等依赖库
  - ❌ 维护成本：需要跟进123云盘API变更

  系统影响

  架构影响

  - 🔄 模块新增：新增pan123_client模块
  - 🔄 配置扩展：upload_drive配置新增字段
  - 🔄 依赖更新：requirements.txt新增httpx

  兼容性影响

  - ✅ 向前兼容：现有配置和功能完全兼容
  - ✅ 平滑升级：用户可选择性启用
  - ✅ 回滚支持：可随时切换回原有云盘

  风险评估

  技术风险

| 风险           | 影响 | 概率 | 缓解措施                       |
| -------------- | ---- | ---- | ------------------------------ |
| 123云盘API变更 | 中   | 低   | 及时跟进官方文档，预留适配时间 |
| 认证令牌失效   | 中   | 中   | 实现自动刷新机制，用户友好提示 |
| 上传限制变更   | 低   | 低   | 动态获取限制参数，弹性处理     |
| 网络连接异常   | 中   | 高   | 完善重试机制，离线排队功能     |

  业务风险

| 风险           | 影响 | 概率 | 缓解措施                     |
| -------------- | ---- | ---- | ---------------------------- |
| 用户配置错误   | 中   | 中   | 详细配置说明，错误信息友好   |
| 云盘容量不足   | 低   | 中   | 上传前容量检查，明确提示     |
| 服务商政策变更 | 高   | 低   | 保持多云盘选择，降低单一依赖 |

---
  📈 成功指标

  技术指标

  - 功能完成度：100%验收标准通过
  - 代码质量：单元测试覆盖率≥80%
  - 性能表现：上传速度达到预期目标
  - 稳定性：上传成功率≥95%

  用户指标

  - 采用率：至少10%用户尝试使用123云盘
  - 满意度：用户反馈评分≥4.0/5.0
  - 问题反馈：严重问题<3个/月
  - 文档评价：配置说明清晰易懂

  业务指标

  - 兼容性：现有用户0影响
  - 扩展性：为后续云盘集成提供参考架构
  - 维护性：代码结构清晰，易于维护
  - 社区反馈：GitHub Issues相关问题解决及时

---
  🎉 预期效果

  最终交付物

  代码模块

  module/
  ├── pan123_client.py          # 🆕 123云盘客户端
  ├── cloud_drive.py           # 🔄 集成123云盘适配器
  ├── app.py                   # 🔄 添加123云盘配置解析
  └── ...

  tests/
  ├── test_pan123_client.py    # 🆕 123云盘单元测试
  ├── test_pan123_integration.py # 🆕 123云盘集成测试
  └── ...

  requirements.txt             # 🔄 新增httpx依赖
  README.md                    # 🔄 添加123云盘配置说明
  README_CN.md                 # 🔄 添加123云盘中文说明

  配置示例

  # 用户配置示例
  save_path: D:\telegram_media_downloader
  file_path_prefix:
    - chat_title
    - media_datetime
    - media_type
  file_name_prefix:
    - message_id
    - file_name
  upload_drive:
    enable_upload_file: true
    upload_adapter: pan123              # 🆕 123云盘选项
    remote_dir: "/telegram"
    client_id: "your_123pan_client_id"  # 🆕 需要用户申请
    client_secret: "your_123pan_secret" # 🆕 需要用户申请
    before_upload_file_zip: false
    after_upload_file_delete: true

  用户体验效果

  使用流程

  1. 配置简单：在config.yaml中设置123云盘参数
  2. 无缝切换：upload_adapter改为pan123即可启用
  3. 功能完整：支持所有现有云盘功能
  4. 反馈及时：上传进度和结果实时显示

  存储结构

  本地存储：
  D:\telegram_media_downloader\
  └── TechChannel\
      └── 2023_12\
          ├── photo\
          │   ├── 12345 - image.jpg
          │   └── 12346 - photo.png
          └── video\
              └── 12347 - video.mp4

  123云盘存储：
  /telegram/
  └── TechChannel/
      └── 2023_12/
          ├── photo/
          │   ├── 12345 - image.jpg
          │   └── 12346 - photo.png
          └── video/
              └── 12347 - video.mp4

  技术收益

  架构优化

  - 统一接口：CloudDrive模块支持更多云盘类型
  - 扩展性强：后续集成其他云盘更容易
  - 代码复用：路径映射、配置管理等逻辑可复用
  - 测试完善：建立云盘集成的测试标准

  开发效率

  - 模块化设计：各云盘适配器独立开发
  - 标准化接口：统一的上传接口和配置格式
  - 文档完善：为后续开发提供参考文档
  - 经验积累：云盘API集成的最佳实践

---
  📚 附录

  API参考文档

  - https://www.123pan.com/developer
  - https://123yunpan.yuque.com/org-wiki-123yunpan-muaork/cr6ced

  相关资源

  - https://github.com/tangyoha/telegram_media_downloader
  - https://github.com/tangyoha/telegram_media_downloader/wiki

  开发依赖

  # 新增依赖
  httpx>=0.24.0         # HTTP异步客户端
  aiofiles>=23.0.0      # 异步文件操作（可选）

  # 开发依赖
  pytest>=7.0.0         # 单元测试框架
  pytest-asyncio>=0.21.0 # 异步测试支持
  responses>=0.23.0     # HTTP Mock测试

  配置模板

  # config.yaml - 123云盘配置模板
  api_hash: your_api_hash
  api_id: your_api_id
  bot_token: your_bot_token

  save_path: ./downloads
  file_path_prefix:
    - chat_title
    - media_datetime
    - media_type
  file_name_prefix:
    - message_id
    - file_name
  file_name_prefix_split: ' - '

  upload_drive:
    enable_upload_file: true
    upload_adapter: pan123
    remote_dir: "/telegram"
    client_id: "your_123pan_client_id"
    client_secret: "your_123pan_client_secret"
    before_upload_file_zip: false
    after_upload_file_delete: true

  media_types:
    - audio
    - document
    - photo
    - video
    - voice
    - animation

  max_download_task: 5

---
  文档版本：v1.0创建日期：2025-01-08最后更新：2025-01-08审核状态：待审核